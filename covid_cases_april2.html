<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Style circles with a data-driven property</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://api.mapbox.com/mapbox-gl-js/v1.8.1/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.8.1/mapbox-gl.css" rel="stylesheet" />
         <script src='https://unpkg.com/@turf/turf/turf.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js" integrity="sha256-Xb6SSzhH3wEPC4Vy3W70Lqh9Y3Du/3KxPqI2JHQSpTw=" crossorigin="anonymous"></script>
<style>
	body { margin: 0; padding: 0; }
	#map { position: absolute; top: 0;  width: 98%; height:95%;}
  
     #mySelect{ position: absolute; top: 600; }
    .map-overlay {
  position: absolute;
  bottom: 0;
  right: 0;
  background: rgba(255, 255, 255, 0.8);
  margin-right: 20px;
  font-family: Arial, sans-serif;
  overflow: auto;
  border-radius: 3px;
        
}

#features {
  top: 0;
  height: 130px;
  margin-top: 20px;
  width: 280px;
}

#legend {
  padding: 10px;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  line-height: 18px;
  height: 10px;
  margin-bottom: 60px;
  width: 280px;
}

.legend-key {
  display: inline-block;
  border-radius: 20%;
  width: 10px;
  height: 10px;
  margin-right: 5px;
}
    select{
        height:25px;
        line-height:25px;
    }   
</style>
</head>
<body>
<body>
    
     

<div id="map"></div> <div id="map2"></div>
    
 
    
    <div class='map-overlay'  id="features">
        <select id="mySelect"></select>
        <br>
        <div id='pd'>
        <br> <input type="checkbox" id="covid" name="checks" value="covid"> COVID-19 cases
        <br> <input type="checkbox" id="counties" name="checks" value="counties"> Counties
     <br><input type="checkbox" id="communities" name="checks" value="communities"> Small communities
        <br><input type="checkbox" id="states" name="checks" value="states"> State borders
        </div></div>
<div class='map-overlay' id='legend'>
    Data source: <a href="https://www.safegraph.com/">SafeGraph Inc.</a>
    
    
    </div>
    
    
<script>
  //Apr05-11_2_small_simplified2_2.json

 fetch('Apr05-11_2_small_simplified2_2.json', {
      headers : { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
       }

    }).then(res => res.json()) 
  .then(data => {

  var data0={"type":"FeatureCollection","features":[]};
      var maxes=[];
  for (var i=0; i< data["features"].length; i++) {
		  var temp={"type":"Point"};
      //console.log(data["features"][i]["properties"]["center"]);
		   if (data["features"][i]["properties"]["center"].length==2) {
		       temp["coordinates"]=data["features"][i]["properties"]["center"];
		       data0["features"].push({"geometry":temp,"properties":{"Apr11_diff":Math.log(Number(data["features"][i]["properties"]["Apr11_diff"])+1.01),"Apr11_diff_nl":data["features"][i]["properties"]["Apr11_diff"],"GEOID":data["features"][i]["properties"]["GEOID"]}});
 //     maxes.push(Math.log(Number(data["features"][i]["properties"]["Apr11_diff"])+1.001));
		   } else {

		      // maxes.push(Math.log(data["features"][i]["properties"]["Apr11_diff"]+1.01));
		       
                   temp["coordinates"]=data["features"][i]["geometry"]["coordinates"];
		       data0["features"].push({"geometry":temp,"properties":{"Apr11_diff":Math.log(data["features"][i]["properties"]["Apr11_diff"]+1.01),"Apr11_diff_nl":data["features"][i]["properties"]["Apr11_diff"],"GEOID":data["features"][i]["properties"]["GEOID"]}});
		   }
   
  }



  
  
mapboxgl.accessToken = 'pk.eyJ1Ijoib2J1Y2hlbCIsImEiOiJmOWQ2MzQxNmE0M2Y3YmVjNzA2NmM2MGQzYTIwYmQ3OCJ9.psxJSN8q9n2-HfFGoIUNJA';
var map = new mapboxgl.Map({
container: 'map',
style: 'mapbox://styles/mapbox/streets-v11',
zoom: 3,
center: [-82.447303,37.753574]
});
map.addControl(new mapboxgl.NavigationControl(), 'top-left');      
map.addControl(new mapboxgl.FullscreenControl(), 'top-right');            
            
map.on('load', function() {     
map.addSource('communities_large_Feb23-29', {
type: 'geojson',
 data:data 
});
map.addSource('circles', {
type: 'geojson',
 data:data0
});


    /*


#fff5f0
#fee0d2
#fcbba1
#fc9272
#fb6a4a
#ef3b2c
#cb181d
#a50f15
#67000d


    */

//    console.log(d3.extent(maxes));
map.addLayer({
'id': 'communities_large_Feb23-29',
'type': 'fill',
'source': 'communities_large_Feb23-29',
'paint': {
'fill-color':{
            type: 'identity',
    property: 'color'
//    stops: [[-100,"#ffffff"],[0, '#fff5f0'], [(d3.max(maxes)-d3.min(maxes))/5, '#fee0d2'], [(d3.max(maxes)-d3.min(maxes))/5*4, '#a50f15'],[d3.max(maxes)+1, '#67000d']]
        },   
'fill-outline-color':'black',    
'fill-opacity': 0.8
}

},"state-label");

    
 map.addLayer({
'id': 'population',
'type': 'circle',
'source': 'circles',
'paint': {
    'circle-radius': {'type':'identity',
 'property': 'Apr11_diff'},
    'circle-color':  '#cccccc',
    'circle-stroke-color':'#000000',
    'circle-stroke-width':0.4
}
 });

    map.on('click', 'population', function(e) {

//	alert("hgyhgugjh");
//	alert(e.features[0].properties["Apr11_diff_nl"])

	console.log(e.features[0]["properties"]);
var popup=new mapboxgl.Popup()
.setLngLat(e.lngLat)
.setHTML("Cases in "+e.features[0]["properties"]["GEOID"]+" over two weeks prior to Apr 11, 2020: "+e.features[0]["properties"]["Apr11_diff_nl"])
.addTo(map);
	
    });
  
     });
  });       
</script>
</body>
</html>
